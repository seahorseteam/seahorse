package kks.example.seahorsegear2;

import android.app.Activity;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.EditText;
import android.widget.Toast;

import com.samsung.android.example.helloaccessoryprovider.R;
import com.samsung.android.sdk.accessory.SASocket;

/**
 * 기어2와 통신을 하기 위한 서비스 작성 예제 소스.
 * 
 * @author KKS
 * 
 */
public class MainActivity extends Activity {
	private GearMsgReceiveListener listener;
	private GearSocket socket;
	private EditText editText;
	private boolean bConnecting;
	private Runnable gearConnectRunnable = new Runnable() {
		@Override
		public void run() {
			bConnecting = true;
			while (bConnecting) {
				SASocket sock = GearService.getSocket();
				if (sock != null) {
					socket.setGearSocket(sock);
					bConnecting = false;
				}
			}
		}
	};

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_main);

		editText = (EditText) findViewById(R.id.editText);
		listener = new GearMsgReceiveListener() {
			@Override
			public void receivedData(String msg) {
				socket.sendMessage(msg + " fetch received.");
				Toast.makeText(getApplicationContext(), msg, Toast.LENGTH_LONG)
						.show();
			}
		};

		// 내가 사용할 통신 매체.
		socket = new GearSocket();
		// 채널 설정. 이는 반드시 android의 profile.xml, tizen wearable의 profile.xml과 일치해야
		// 하며, main.js에서 쓰는 채널 값도 맞춰야 한다.
		socket.setAccessoryChannelID(104);
		// 기어에서 전달한 메시지를 받을 리스너.
		socket.addReceivedMsgListener(listener);
		connectGear();
	}

	public void sendMsg(View v) {
		try {
			if (socket.getGearSocket().isConnected() == false) {
				// SASocket만 끊긴 경우에 재접속.
				Toast.makeText(this, "기어와 연결이 되지 않았습니다.", Toast.LENGTH_SHORT)
						.show();
				connectGear();
			}

			// 연결이 끊긴 경우, 기어에서 30초마다 재연결을 수행한다. 30초 뒤에 메시지를 다시 보내면 된다.
			String str = editText.getText().toString();
			if (!str.equalsIgnoreCase("")) {
				socket.sendMessage(str);
				editText.setText("");
			}
		} catch (Exception e) {
			// socket lost.
			Toast.makeText(this, "기어와 연결이 끊겼습니다.", Toast.LENGTH_SHORT).show();
			connectGear();
			Log.d("Test", e.getMessage());
		}
	}

	// socket이 언제 연결이 될지 모른다. Thread로 계속해서 받는 순간을 체크한다.
	private void connectGear() {
		// 쓰레드 중복 실행 방지. sendMsg 연타하는 경우.
		if (bConnecting == false) {
			new Thread(gearConnectRunnable).start();
		}
	}

}
